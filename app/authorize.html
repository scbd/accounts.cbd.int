<!DOCTYPE html>
<html lang="en">
<body>
<script>

function getCookie(cname) {

    var name = cname + "=";
    var ca = document.cookie.split(';');

    for(var i=0; i<ca.length; i++) {
        var c = ca[i].trim();
        if (c.indexOf(name)==0) return c.substring(name.length,c.length);
    }
    return "";
}

function setCookie(cname, cvalue, exdays)
{
    if(cvalue===null || cvalue === undefined)
        exdays = -365;

    var parts = [cname + "=" + (cvalue||"")];

    var d = new Date();
    if(exdays && typeof exdays == 'string') {
        d = new Date(exdays);
    }
    else if(exdays)
        d.setDate(d.getDate()+exdays);

    parts.push("expires="+d.toGMTString())
    parts.push("path=/");

    document.cookie =  parts.join("; ");
}

var allowedHosts = [ 'www','absch', 'bch', 'chm', 'eunomia', 'inde', 'lifeweb', 'localhost', 'training-absch', 'dev-absch', 'dev-chm' ];

function receiveMessage(event) {

    var secureDomain = document.location.hostname.replace(/[^\.]+\./, '');
    var origin = event.origin;

    if(origin=='http://localhost' || /^http:\/\/localhost:/.test(origin)) origin = 'https://localhost.'+secureDomain;

    var originDomain = origin.match(/(?:^(https)\:\/\/)([^\.]+)\.([^\/]+)/)[3];
    var originHost   = origin.match(/(?:^(https)\:\/\/)([^\.]+)\.([^\/]+)/)[2];

    if(originDomain==secureDomain && ~allowedHosts.indexOf(originHost)) {

        var message = JSON.parse(event.data);

        if(message.type=='getAuthenticationToken') {
            
            var response = { 
                type                : 'authenticationToken', 
                authenticationToken : getCookie('authenticationToken'), 
                authenticationEmail : getCookie('email'), 
                expiration         : getCookie('expiration') 
            };
            if(response && response.expiration){
                if(new Date(response.expiration).getTime() <= new Date().getTime()){
                    response.sessionexpired = true;
                }
            }
            window.parent.postMessage(JSON.stringify(response), event.origin);
        }

        if(message.type=='setAuthenticationToken') {

            if(message.authenticationToken) setCookie('authenticationToken', message.authenticationToken, message.expiration);
            else                            setCookie('authenticationToken', null); //Delete the cookie

            if(message.authenticationEmail)        setCookie('email', message.authenticationEmail, 365);
            if(message.authenticationEmail===null) setCookie('email', null); //Delete the cookie

            if(message.expiration)        setCookie('expiration', message.expiration, 365);
            else                          setCookie('expiration', null); //Delete the cookie
        }
    }
}

window.addEventListener('message', receiveMessage, false);

</script>
</body>
</html>
